generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum AccountType {
  CHEQUING
  SAVINGS
  CREDIT_CARD
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum TransactionStatus {
  POSTED
  PENDING
}

enum FraudReviewStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ETransferStatus {
  PENDING
  DEPOSITED
  DECLINED
  CANCELLED
  EXPIRED
}

enum PaymentFrequency {
  ONE_TIME
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum ScheduledPaymentStatus {
  SCHEDULED
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
}

enum DisputeStatus {
  SUBMITTED
  IN_REVIEW
  RESOLVED
  REJECTED
}

enum DisputeReason {
  FRAUD
  SERVICE_NOT_RECEIVED
  DUPLICATE
  INCORRECT_AMOUNT
  OTHER
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  accounts  Account[]
  flaggedTransfers FlaggedTransfer[]
  settings  UserSettings?
  contacts  Contact[]
  sentETransfers ETransfer[] @relation("SentETransfers")
  receivedETransfers ETransfer[] @relation("ReceivedETransfers")
  payees    Payee[]
  scheduledPayments ScheduledPayment[]
  categories Category[]
  categorizationRules CategorizationRule[]
  budgets   Budget[]
  disputes  Dispute[]
  trustedDevices TrustedDevice[]

  mfaEnabled Boolean   @default(false)
  mfaSecret  String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model UserSettings {
  id String @id @default(cuid())
  userId String @unique
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  autoDepositEnabled Boolean @default(false)
  autoDepositAccountId String?
  autoDepositAccount Account? @relation("AutoDepositAccount", fields: [autoDepositAccountId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  email String?
  phone String?
  lastUsedAt DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([phone])
}

model Account {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          AccountType
  balance       Float
  accountNumber String        @unique
  transactions  Transaction[]
  flaggedTransfers FlaggedTransfer[] @relation("FromAccountFlaggedTransfers")
  incomingETransfers ETransfer[] @relation("IncomingETransfers")
  outgoingETransfers ETransfer[] @relation("OutgoingETransfers")
  scheduledPayments ScheduledPayment[]
  autoDepositFor UserSettings[] @relation("AutoDepositAccount")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
}

model Transaction {
  id          String             @id @default(cuid())
  accountId   String
  account     Account            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  amount      Float
  type        TransactionType
  description String
  merchant    String?
  memo        String?
  date        DateTime
  status      TransactionStatus
  categoryId  String?
  category    Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  eTransferId String?
  eTransfer   ETransfer?         @relation(fields: [eTransferId], references: [id], onDelete: SetNull)
  dispute     Dispute?           @relation("TransactionDispute")
  createdAt   DateTime           @default(now())

  @@index([accountId])
  @@index([date])
  @@index([categoryId])
}

model Category {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  name String
  color String?
  createdAt DateTime @default(now())

  transactions Transaction[]
  rules CategorizationRule[]
  budgets Budget[]

  @@unique([userId, name])
  @@index([userId])
}

model CategorizationRule {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  pattern String
  isRegex Boolean @default(false)
  priority Int @default(100)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([categoryId])
  @@index([priority])
}

model Budget {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  month Int
  year Int
  amount Float
  createdAt DateTime @default(now())

  @@unique([userId, categoryId, month, year])
  @@index([userId])
  @@index([month, year])
}

model ETransfer {
  id String @id @default(cuid())

  senderUserId String
  senderUser User @relation("SentETransfers", fields: [senderUserId], references: [id], onDelete: Cascade)

  receiverUserId String?
  receiverUser User? @relation("ReceivedETransfers", fields: [receiverUserId], references: [id], onDelete: SetNull)

  fromAccountId String
  fromAccount Account @relation("OutgoingETransfers", fields: [fromAccountId], references: [id], onDelete: Cascade)

  toAccountId String?
  toAccount Account? @relation("IncomingETransfers", fields: [toAccountId], references: [id], onDelete: SetNull)

  toEmail String?
  toPhone String?

  amount Float
  memo String?
  securityQuestion String?
  status ETransferStatus @default(PENDING)

  createdAt DateTime @default(now())
  respondedAt DateTime?
  depositedAt DateTime?
  expiresAt DateTime?

  transactions Transaction[]

  @@index([senderUserId])
  @@index([receiverUserId])
  @@index([status])
  @@index([createdAt])
}

model Payee {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  name String
  payeeCode String?
  createdAt DateTime @default(now())

  scheduledPayments ScheduledPayment[]

  @@unique([userId, name])
  @@index([userId])
}

model ScheduledPayment {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  fromAccountId String
  fromAccount Account @relation(fields: [fromAccountId], references: [id], onDelete: Cascade)

  payeeId String
  payee Payee @relation(fields: [payeeId], references: [id], onDelete: Cascade)

  amount Float
  reference String?
  frequency PaymentFrequency @default(ONE_TIME)
  startDate DateTime
  nextRunAt DateTime
  lastRunAt DateTime?
  status ScheduledPaymentStatus @default(SCHEDULED)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([fromAccountId])
  @@index([payeeId])
  @@index([nextRunAt])
  @@index([status])
}

model Dispute {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactionId String @unique
  transaction Transaction @relation("TransactionDispute", fields: [transactionId], references: [id], onDelete: Cascade)

  caseNumber String @unique
  reason DisputeReason
  status DisputeStatus @default(SUBMITTED)
  comments String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model TrustedDevice {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  label String
  deviceId String
  lastSeenAt DateTime?
  createdAt DateTime @default(now())

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([lastSeenAt])
}

model FlaggedTransfer {
  id               String            @id @default(cuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromAccountId    String
  fromAccount      Account           @relation("FromAccountFlaggedTransfers", fields: [fromAccountId], references: [id], onDelete: Cascade)
  toEmail          String
  amount           Float
  securityQuestion String
  status           FraudReviewStatus @default(PENDING_REVIEW)
  createdAt        DateTime          @default(now())
  reviewedAt       DateTime?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
